Bootstrap: docker
From: firedrakeproject/firedrake-vanilla:2024-04
Stage: spython-base

%labels
authors="hosseinkhan"

%post
# Firedrake change uid approach
su -  root # USER root
usermod -u $USER_ID firedrake
groupmod -g $GROUP_ID firedrake

# Switch back to firedrake
su -  firedrake # USER firedrake

# Source the firedrake environment
PATH_FIREDRAKE_VENV_ACTIVATION_SCRIPT=/home/firedrake/firedrake/bin/activate

# Create a directory for mounting
mkdir -p /home/firedrake/mount_dir/project_root/

/bin/bash -c "source $PATH_FIREDRAKE_VENV_ACTIVATION_SCRIPT && \
pip install --upgrade pip==24.0 && \
pip install gymnasium \
git+https://github.com/ReHoss/hydrogym.git@feature/add_back_coarse_meshes \
jsonschema \
matplotlib \
mlflow==1.27.0 \
numpy \
pandas \
pyyaml \
sb3-contrib \
scipy \
tensorboard \
tqdm \
"

mkdir -p /home/firedrake/mount_dir/project_root
cd /home/firedrake/mount_dir/project_root

# Set the PYTHONPATH
PYTHONPATH="/home/firedrake/mount_dir/project_root:$PYTHONPATH"

# PRINT THE CURRENT ENVIRONMENT TO THE TERMINAL
/bin/bash -c "echo 'Current python: $(which python)' && \
echo 'Current pip: $(which pip)' && \
echo 'Current python version: $(python --version)' && \
echo 'Current pip version: $(pip --version)' && \
echo 'Current pip list: $(pip list)'"

%environment
export PATH_FIREDRAKE_VENV_ACTIVATION_SCRIPT=/home/firedrake/firedrake/bin/activate
export PYTHONPATH="/home/firedrake/mount_dir/project_root:$PYTHONPATH"

%runscript
cd /home/firedrake/mount_dir/project_root || exit
exec /bin/bash -l -c ". /home/firedrake/firedrake/bin/activate && /bin/bash $*"
